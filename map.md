# КАРТА ПРОЕКТА

> **Главное правило:** любые планы, изменения планов и отметки о выполнении фиксируются **только** в этом файле. 
Если появился новый пункт плана - добавляем его сюда, завершили шаг — ставим отметку `[x]` напротив соответствующей строки соответствующего блока. 

> **Второе правило:** Мы пишем надежный код на Cи, поэтому стараемся использовать power of ten rules NASA:
1. Avoid complex flow constructs, such as goto and recursion.
2. All loops must have fixed bounds. This prevents runaway code.
3. Avoid heap memory allocation after initialization.
4. Restrict functions to a single printed page.
5. Use a minimum average of two runtime assertions per function.
Use this MACRO:
```
#define ASSERT(expr)                                                           \
  do {                                                                         \
    if (!(expr)) {                                                             \
      syslog2(LOG_CRIT, "VERIFY FAILED: %s at %s:%d in %s()", #expr, __FILE__, \
              __LINE__, __func__);                                             \
      abort();                                                                 \
    }                                                                          \
  } while (0)
```
6. Restrict the scope of data to the smallest possible.
7. Check the return value of all non-void functions, or cast to void to indicate the return value is useless.
8. Use the preprocessor only for header files and simple macros.
9. Limit pointer use to a single dereference, and do not use function pointers.
10. Compile with all possible warnings active; all warnings should then be addressed before release of the software.

> **Остальные правила:**
1. комментарии пишем через //, используем /**/ только если нужно поместить комментарий внутри строки кода
2. пишем комментарии и вообще все сообщения в лог не соблюдая правило первой заглавной буквы в приложении
3. используем для логов формат param=value для упрощения машиночитаемости логов
4. в коде допускается русский язык для комментариев. Все что печатается на экран или в буфферы только на английском

## Верхнеуровневая структура
- `l2shell/` — каталог OpenWrt-пакета.
  - `Makefile` — описание пакета для OpenWrt.
  - `src/` — переносимый исходный код и вспомогательные скрипты (содержит прежний набор файлов).
    - `Makefile` — собирает два бинарника: `a` (сервер) и `b` (клиент); цель `all` также делает статические варианты.
    - `server.c` — реализация L2-сервера: ждет init-кадр от клиента, запускает описанную в нем команду в PTY и прокидывает байты через Ethernet, если команды нет, запускается дефолтный /bin/sh
    - `client.c` — реализация L2-клиента: просто отправляет и принимает команды на сервер.
    - `common.c/.h`, `hello_proto.h` — общие типы пакетов, шифрование и контрольная сумма, работа с сокетами и HELLO-трафиком.
    - `l2shell_kmod.c` — модуль ядра, предназначен для запуска сервера через `call_usermodehelper` при получении соответствующего фрейма по eth. на время работы сервера перехват фреймов в ядре отключается. При завершении включается снова.
    - `scripts/` — служебные скрипты, в т.ч. `test_local.sh` для end-to-end теста через veth.
    - `tests/` — юнит-тесты общих хелперов (`tests/common_tests.c`, shared-хедер `tests/test_common_shared.h`).
    - `test_util.h` — минимальный тестовый раннер + перехват аллокаторов для fault-injection; используется тестами без внешних зависимостей.
    - `logs/` — логи
- `README.md` — краткая инструкция по сборке и запуску.

## Общие концепции
- Пользовательский EtherType `0x88B5`, структура `pack_t` содержит Ethernet-заголовок, сигнатуру отправителя и до 1024 байт полезной нагрузки.
- Подписи `CLIENT_SIGNATURE` и `SERVER_SIGNATURE` позволяют фильтровать «свои» кадры.
- `enc_dec` — симметричное XOR с ключом на базе CRC и соли `key_magic`.
- `calculate_checksum` пишет простую покадровую сумму в поле `crc`
- **Стиль кодирования**: K&R, 4 пробела на отступ, брейсы на той же строке с сигнатурой. Функции/глобальные переменные именуются `lowercase_with_underscores`. 
Стараемся не переносить сигнатуры и вызовы функций на две строки даже при превышении мягкого лимита в 80 символов. 
Любой новый код обязан следовать этим правилам и списку Power-of-Ten из начала файла. 
Предпочитаем `static inline` хелперы в `common.h`, а не макросы.
- Короткие однострочные условия записываем без фигурных скобок (`if (cond) return;`). Если тело `if/for/while` занимает больше одной строки — фигурные скобки обязательны.
- **Rule of Least Surprise**: все сообщения, предупреждения и поведение должны быть очевидными человеку, читающему вывод. Если негативный сценарий теста выводит `error`, рядом должно быть пояснение, что это ожидаемо и почему.

### Активные задачи
1. [x] Расширить юнит-тесты (prepared packet, валидация фреймов, лог-хелперы) и включить их в стандартный таргет сборки.
1. [x] Декомпозировать большие функции (`client.c`, `server.c`) на короткие шаги.
1. [x] Добавить тайм-аут на стороне сервера: при отсутствии трафика от клиента `SERVER_IDLE_TICKS` закрывать PTY и выходить из цикла.
1. [x] Унифицировать логирование и диагностику через общие хелперы с форматом `param=value`.
1. [x] Добавить runtime-assertions в основные функции и покрыть их тестами.
1. [x] Доработать `common.c`, `client.c`, `server.c`: добавить HELLO (версия `0x01`, TLV `0x01`/`0x02`/`0x03`), чтобы клиент всегда отправлял обе записи, а сервер корректно парсил и запускал shell.
1. [x] Обновить модуль ядра: добавить поддержку HELLO версии `0x01` с теми же TLV и запускать сервер до возврата трафика.


### План рефакторинга протокола и IO
1. [x] Ввести единый модуль протокола `proto.[ch]`: описать wire-формат (magic, версии, флаги, CRC, порядок полей), перечисления типов сообщений, централизованный расчет длины/CRC и API `l2s_build_frame`/`l2s_parse_frame` с валидацией и hton/ntoh.
1. [x] Перевести `client.c` и `server.c` на новый протокол, оставить только чтение/запись сокета и реакцию на типы сообщений, убрать дублирующий разбор/сборку заголовков.

### Исправить таймаут сервера
- [x] изучить текущую логику `server_loop` и `idle_ticks`
- [x] изменить учёт активности: сброс только при активности клиента
- [x] прогнать `make test` и `make test-kmod`

### Idle timeout negotiation
- [x] добавить HELLO TLV и клиентский `--idle-timeout`
- [x] сервер должен учитывать TTL, ограничивать 600 сек и использовать в цикле
- [x] обновить юнит-тесты, `server.c`, `hello_proto.h`


### Завершенные задачи

## Новая задача
1. [x] добавить HEARTBEAT-сообщения клиенту и серверу, чтобы сервер не завершался, когда клиент подключен, но без активности с клавиатуры (иметь защиту от преждевременного таймаута)
