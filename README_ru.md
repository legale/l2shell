# l2shell
L2-шел: клиент и сервер обмениваются ethernet-кадрами с пользовательским EtherType (`0x88B5`) и передают HELLO/команды в обход IP-стека.

## Сборка
Нужны Linux, `make` и компилятор C. Клонируем репозиторий и собираем из каталога `src/`:

```sh
git clone https://github.com/legale/l2shell
cd l2shell/src
make
```

На выходе получаем:
- `l2shell`: релизный бинарник (режим определяется аргументами).
- `l2shell_dbg`: отладочная сборка с символами.
- `l2shell_static`: полностью статический вариант.
- `a` / `b`: симлинки, жёстко включающие режим сервера/клиента.

`make test-unit` гоняет юнит-тесты, `make test` (с `sudo`) — e2e-скрипт на veth, `make kmod` собирает модуль ядра `l2shell_kmod.ko`; перед его компиляцией установите заголовки ядра вашей текущей версии.

## Использование
`l2shell` — единый бинарник с подпроцессами `server` и `client`. Можно вызывать `./l2shell server ...`, `./l2shell client ...` или симлинки `./a`/`./b`. Доступ к raw Ethernet обычно требует root.

### Типичный сценарий
1. Поднимаем сервер и разрешаем обработку кадров с любого интерфейса, отвечаем через тот же интерфейс:
   ```sh
   sudo ./l2shell server any
   ```
2. На клиентской машине указываем интерфейс и MAC адрес сервера:
   ```sh
   sudo ./l2shell client <ifname> <server_mac>
   ```
   После обмена HELLO сервер стартует `login` по умолчанию, если не передать другой shell через CLI клиента.

### Сервер
```
./l2shell server [--log-file <путь>] <interface|any>
```
- `<interface>` — интерфейс для бинда (например `eth0`).
- `any` включает режим «слушать все интерфейсы» с ответом в тот, откуда пришёл кадр.
- `--log-file` перенаправляет stdout/stderr в файл (логи пишутся в формате `param=value`).

Сервер ждёт HELLO от клиента и запускает shell в PTY. Если клиент указал команду (например `/bin/sh`), запускается она, иначе `/bin/login`. При отсутствии трафика дольше оговорённого таймаута (по умолчанию 30 с, максимум 600 с) сервер закрывает shell.

### Клиент
```
./l2shell client [options] <iface> <server-mac> [shell] [cmd]
```
Обязательные аргументы:
- `<iface>`: интерфейс для отправки кадров (должен находиться в одном L2-сегменте с сервером).
- `<server-mac>`: MAC-адрес назначения (`aa:bb:cc:dd:ee:ff`).

Дополнительные позиционные аргументы:
- `shell`: команда, которую нужно запустить на сервере вместо `login`.
- `cmd`: одноразовая команда после HELLO. Если пропустить, клиент уходит в интерактив и пробрасывает stdin/stdout.

Флаги:
- `-e`, `--echo`: печатает локально то, что вводите (удобно без TTY).
- `--spawn <path>`: попросить модуль ядра запустить указанный бинарник сервера (если сервер поднимается из ядра).
- `--idle-timeout <sec>`: предложить таймаут простоя (1-600 с).
- `--log-file <path>`: направить логи клиента в файл.
- `-h`, `--help`: краткая справка.

Если передан `cmd`, клиент единожды отправляет его (добавляя CR/LF), ждёт ответ и завершает работу. Без `cmd` stdin переводится в raw-режим и клиент становится прозрачным PTY с опциональным локальным эхом.

## Структура репозитория
- `src/`: пользовательский код, Makefile, тесты и скрипты (сборка ведётся отсюда).
- `openwrt/`: паковка под OpenWrt.
- `logs/`: каталог с логами.
- `map.md`: карта задач и правила разработки — обязательно прочитайте перед изменениями.
